name: Keep Codespace Alive

# 每 10 分钟执行一次，防止 Codespaces 休眠
on:
  schedule:
    - cron: '*/10 * * * *'  # 每10分钟
  workflow_dispatch:       # 手动触发

jobs:
  ping-codespace:
    runs-on: ubuntu-latest
    name: Ping Codespace to prevent sleep

    steps:
      - name: Wake up Codespace via GitHub API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          # 获取 Codespaces 列表
          echo "Checking active Codespaces..."
          response=$(curl -s -H "Authorization: token $GITHUB_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/codespaces)

          # 如果没有 Codespaces，直接退出
          codespace_count=$(echo "$response" | jq '. | length')
          if [ "$codespace_count" -eq 0 ]; then
            echo "No active Codespaces found. Exiting."
            exit 0
          fi

          echo "Found $codespace_count Codespace(s)"
          echo "$response" | jq '.'

          # 尝试 ping 每个 Codespace
          echo "$response" | jq -r '.[] | @base64' | while read -r code; do
            _jq() {
              echo "${code}" | base64 -d | jq -r "${1}"
            }

            name=$(_jq '.name')
            location=$(_jq '.location')

            echo "Pinging Codespace: $name"
            echo "  Location: $location"

            # 使用 GitHub API 获取 Codespace 详情（这会保持它活跃）
            curl -s -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/user/codespaces/$name | jq '. | keys'

            echo "  ✓ Pinged successfully"
          done

          echo "✓ Codespace keep-alive check completed"
