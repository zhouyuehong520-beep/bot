name: Keep Codespace Alive

# æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ Codespaces ä¼‘çœ 
on:
  schedule:
    - cron: '*/10 * * * *'  # æ¯10åˆ†é’Ÿ
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  ping-codespace:
    runs-on: ubuntu-latest
    name: Ping Codespace to prevent sleep

    steps:
      - name: Wake up Codespace using GitHub CLI
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -e
          
          echo "ğŸ” Installing GitHub CLI..."
          
          # å®‰è£… GitHub CLIï¼ˆå¦‚æœè¿˜æ²¡å®‰è£…ï¼‰
          if ! command -v gh &> /dev/null; then
            curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
            echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
            sudo apt update
            sudo apt install gh -y
          fi
          
          echo "ğŸ” Checking active Codespaces..."
          
          # ä½¿ç”¨ gh cli åˆ—å‡º Codespaces
          gh codespace list --limit 100 > /tmp/codespaces.txt
          
          # æ£€æŸ¥æ˜¯å¦æœ‰è¾“å‡º
          if [ ! -s /tmp/codespaces.txt ]; then
            echo "âœ… No active Codespaces found. Nothing to do."
            exit 0
          fi
          
          echo "ğŸ“Š Found Codespaces:"
          cat /tmp/codespaces.txt
          
          # è·å–ç¬¬ä¸€ä¸ª Codespace çš„åç§°
          codespace_name=$(head -1 /tmp/codespaces.txt | awk '{print $1}')
          
          if [ -z "$codespace_name" ]; then
            echo "âŒ Could not find any Codespace"
            exit 1
          fi
          
          echo ""
          echo "ğŸ“ Pinging Codespace: $codespace_name"
          
          # å°è¯•æ‰§è¡Œä¸€ä¸ªç®€å•çš„å‘½ä»¤æ¥ä¿æŒæ´»è·ƒ
          gh codespace ssh -c "$codespace_name" -- echo "Keep-alive ping: $(date -u)" || {
            echo "âš ï¸  SSH failed, trying API instead..."
            
            # å¦‚æœ SSH å¤±è´¥ï¼Œå°è¯•é€šè¿‡ API è·å–ä¿¡æ¯
            gh api /user/codespaces/$codespace_name || {
              echo "âŒ Failed to reach Codespace"
              exit 1
            }
          }
          
          echo ""
          echo "âœ¨ Codespace keep-alive check completed successfully!"
