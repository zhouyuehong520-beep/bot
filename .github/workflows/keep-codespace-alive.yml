name: Keep Codespace Alive

# æ¯ 10 åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼Œé˜²æ­¢ Codespaces ä¼‘çœ 
on:
  schedule:
    - cron: '*/10 * * * *'  # æ¯10åˆ†é’Ÿ
  workflow_dispatch:       # æ‰‹åŠ¨è§¦å‘

jobs:
  ping-codespace:
    runs-on: ubuntu-latest
    name: Ping Codespace to prevent sleep

    steps:
      - name: Wake up Codespace via GitHub API
        env:
          GH_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          set -e
          
          echo "ğŸ” Checking active Codespaces..."
          
          # ä½¿ç”¨æ­£ç¡®çš„ API ç«¯ç‚¹è·å– Codespaces
          response=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/user/codespaces)
          
          # æ£€æŸ¥å“åº”æ˜¯å¦æœ‰æ•ˆ
          if echo "$response" | grep -q '"message"'; then
            echo "âŒ Error: $(echo "$response" | jq -r '.message')"
            echo "ğŸ“‹ Response: $response"
            exit 1
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ Codespaces
          codespace_count=$(echo "$response" | jq '. | length // 0')
          echo "ğŸ“Š Found $codespace_count Codespace(s)"
          
          if [ "$codespace_count" -eq 0 ]; then
            echo "âœ… No active Codespaces found. Nothing to do."
            exit 0
          fi
          
          # æ˜¾ç¤º Codespaces åˆ—è¡¨
          echo "$response" | jq -r '.[] | "- \(.name) (\(.location))"'
          
          # å¯¹æ¯ä¸ª Codespace å‘é€è¯·æ±‚ä»¥ä¿æŒæ´»è·ƒ
          echo "$response" | jq -r '.[] | .name' | while read -r name; do
            echo "ğŸ“ Pinging Codespace: $name"
            
            # è·å– Codespace è¯¦æƒ…ï¼ˆä¿æŒå®ƒæ´»è·ƒï¼‰
            ping_response=$(curl -s -H "Authorization: Bearer $GH_TOKEN" \
              -H "Accept: application/vnd.github.v3+json" \
              https://api.github.com/user/codespaces/$name)
            
            # æ£€æŸ¥æ˜¯å¦æˆåŠŸ
            if echo "$ping_response" | grep -q '"name"'; then
              echo "   âœ… Successfully pinged"
            else
              echo "   âŒ Failed to ping"
              echo "   Response: $ping_response"
            fi
          done
          
          echo ""
          echo "âœ¨ Codespace keep-alive check completed successfully!"
